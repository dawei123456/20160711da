<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>游戏大厅</title>
		<link rel="stylesheet" href="css/game.css" />
		<script type="text/javascript" src="js/jquery-1.10.2.min.js" ></script>
		<script type="text/javascript" src="js/data.js" ></script>
		<script type="text/javascript" src="js/socket.io.js" ></script>
	</head>

	<body>
		<div class="main-con">
			<div class="userinfo">
				<h1></h1>
				<p></p>
				<p></p>
			</div>
			<div class="online">
				<div class="head">
					<h3>在线列表</h3>
					<!--是块级元素会强制换行,默认有margin-->
					<span>78/108</span>
					<!--<div style="clear: both;"></div>-->
				</div>
				<div class="body">
					<table></table>
				</div>
			</div>
			<div class="room">
				<div class="head">
					<h3>房间</h3>
				</div>
				<div class="body">
					
				</div>
			</div>
			<div class="chat">
				<div class="head">
					<h3>聊天信息</h3>
				</div>
				<div class="body">
					<ul></ul>
				</div>
				<div class="footer">
					<input type="text" name="" id="chatmsg" value="" />
					<button id="sendchat">发送</button>
				</div>
			</div>

			<input type="" name="" id="roomname" value="" placeholder="输入房间号" />
			<button id="createroom">创建房间</button>
		</div>
	</body>
<script type="text/javascript">
    var user = null;
    var socket = io('http://localhost:3000',{
		autoConnect : false,
		reconnection : false
	});
	$(function(){
		user = localStorage.getItem("user");
		if(!user){
			window.location.href = "login.html";
			return;
		}else{
			user = JSON.parse(user);
		}
		
		socket.open();//连接服务器
		socket.on('connect',function(){
			user.id = socket.id;//为用户赋值
			user.status = 1;//在线状态
			socket.emit("user.online",user);//向服务器发送上线事件
			initUser(user);
		});
		socket.on("user.online",function(users){
			initOnline(users);
		});
		socket.on("chat.newchat",function(chat){
			showChat(chat,false);
		});
		
		$("#sendchat").click(function(){
			var chat = {
				uname : user.uname,
				msg : $("#chatmsg").val()
			}
			$("#chatmsg").val('');
			showChat(chat,true);//自己显示
			socket.emit("chat.send",chat);
		});
		
		
//		initUser( user );
//		initOnline( users );
//		initRoom(room);
		
		
		function showChat(chat,isme){
			if(isme){
				$(".chat .body ul").append("<li style='text-align: right;'>" + chat.msg + ":" + chat.uname + "</li>");
			}else{
				$(".chat .body ul").append("<li>" + chat.uname + ":" + chat.msg + "</li>");
			}
		}
	});
	function initUser( user ){
		$(".userinfo h1").html(user.uname).next().html("ID:" + user.id)
		.next().html("胜场：" + user.win + "胜率：" + (user.total ? user.win / user.total : 0) + "%");
	}
	
	function initOnline(users){
		var html = "";
		for(var i = 0;i < users.length;i++){
			var temp =users[i];
			html += '<tr>';
			html += '<td>' + temp.uname + '</td>';
			html += '<td>' + temp.id + '</td>';
			html += '<td>' + getStatus(temp.status) + '</td>';
			html += '</tr>';
		}
		
		$(".online table").html(html);
	}
	
	function getStatus(status){
		if(status == 1){
			return "在线";
		}else if(status == 2){
			return "准备中";
		}else if(status == 3){
			return "游戏中";
		}else{
			return "";
		}
	}
	
	function initRoom(room){
		var html ="";
		for(var i = 0 ; i < room.length;i++){
			var temp = room[i];
			html += '<div>';
			html += '<img src="img/room.png"/>'
			html += '<p>' + temp.roomname + '</p>'
			html += '</div>'
		}
		$(".room .body").html(html);
	}
</script>
</html>